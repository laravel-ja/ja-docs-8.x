# リクエストのライフサイクル

- [イントロダクション](#introduction)
- [ライフサイクル概論](#lifecycle-overview)
    - [最初のステップ](#first-steps)
    - [HTTP／コンソールカーネル](#http-console-kernels)
    - [サービスプロバイダ](#service-providers)
    - [ルート](#routing)
    - [最後](#finishing-up)
- [サービスプロバイダに注目](#focus-on-service-providers)

<a name="introduction"></a>
## イントロダクション

「現実の世界」でツールを使用するとき、そのツールがどのように機能するかを理解していれば、より自信を感じられます。アプリケーション開発も例外ではありません。開発ツールがどのように機能するかを理解すると、それらをより快適に、自信を持って使用できるようになります。

このドキュメントの目的は、Laravelフレームワークがどのように機能するかについての概要を説明することです。フレームワーク全体をよりよく理解することで、すべてが「魔法」ではなくなり、アプリケーションの構築に自信が持てるようになります。すべての用語をすぐに理解できない場合でも、戸惑う必要はありません。何が起こっているのかという基本的な部分を把握しておけば、ドキュメントの他のセクションを探索するにつれて知識が深まります。

<a name="lifecycle-overview"></a>
## ライフサイクル概論

<a name="first-steps"></a>
### 最初のステップ

Laravelアプリケーションへのすべてのリクエストのエントリポイントは`public/index.php`ファイルです。すべてのリクエストは、Webサーバ(Apache/Nginx)設定によってこのファイルに送信されます。`index.php`ファイルには多くのコードが含まれていません。むしろ、フレームワークの残りの部分をロードするための開始点と言えるでしょう。

`index.php`ファイルは、Composerで生成したオートローダー定義をロードし、Laravelアプリケーションのインスタンスを`bootstrap/app.php`から取得します。Laravel自体が取る最初のアクションは、アプリケーション／[サービスコンテナ](/docs/{{version}}/container)のインスタンスを作成することです。

<a name="http-console-kernels"></a>
### HTTP／コンソールカーネル

次に、アプリケーションへ入ってきたリクエストのタイプに応じて、受信リクエストをHTTPカーネルかコンソールカーネルのいずれかに送信します。これらの２つのカーネルは、すべてのリクエストが通る中心的な場所として機能します。ここでは、`app/Http/Kernel.php`にあるHTTPカーネルに注目しましょう。

HTTPカーネルは`Illuminate\Foundation\Http\Kernel`クラスを拡張します。このクラスはリクエストが実行される前に実行される`bootstrappers`の配列を定義しています。これらのブートストラッパーは、エラー処理の構成、ログの構成、[アプリケーション環境の検出](/docs/{{version}}/configuration#environment-configuration)、およびリクエストが実際に処理される前に実行する必要のあるその他のタスクを実行します。通常、これらのクラスは、皆さんが関わる必要のないLaravelの内部設定を処理します。

HTTPカーネルは、すべてのリクエストがアプリケーションによって処理される前に通過する必要があるHTTP[ミドルウェア](/docs/{{version}}/middleware)のリストも定義します。これらのミドルウェアは、[HTTPセッション](/docs/{{version}}/session)の読み取りと書き込み、アプリケーションがメンテナンスモードであるかどうかの判断、[CSRFトークンの確認](/docs/{{version}}/csrf)などを処理します。これらはこの後すぐに詳しく説明します。

HTTPカーネルの`handle`メソッドの引数は非常に単純です。`Request`を受け取り、`Response`を返します。カーネルをアプリケーション全体を表す大きなブラックボックスであると考えてください。HTTPリクエストを取り込み、HTTPレスポンスを返します。

<a name="service-providers"></a>
### サービスプロバイダ

最も重要なカーネル初期起動処理アクションの１つは、アプリケーションの[サービスプロバイダ](/docs/{{version}}/provider)をロードすることです。アプリケーションのすべてのサービスプロバイダは、`config/app.php`構成ファイルの`providers`配列で構成されます。

Laravelはこのプロバイダのリストを繰り返し処理し、それぞれをインスタンス化します。プロバイダをインスタンス化した後、すべてのプロバイダの`register`メソッドを呼び出します。次に、すべてのプロバイダを登録し、各プロバイダで`boot`メソッドを呼び出します。

サービスプロバイダは、データベース、キュー、バリデーション、ルーティングコンポーネントなど、フレームワークのさまざまなコンポーネントすべてを初期起動する責務を持っています。Laravelが提供する基本的なすべての主機能は、サービスプロバイダによって初期起動および設定されます。フレームワークによって提供される非常に多くの機能を初期起動し設定するため、サービスプロバイダはLaravel初期起動プロセス全体の最も重要な側面です。

`boot`メソッドを呼び出す前に、すべてのサービスプロバイダの`register`メソッドを呼び出すのはなぜか疑問に思われるかもしれません。答えは簡単です。すべてのサービスプロバイダの`register`メソッドを最初に呼び出すことにより、サービスプロバイダは、`boot`メソッドが実行されるまでに登録され利用可能になるすべてのコンテナ結合へ依存できるのです。

<a name="routing"></a>
### ルート

アプリケーションで最も重要なサービスプロバイダの１つは、`App\Providers\RouteServiceProvider`です。このサービスプロバイダは、アプリケーションの`routes`ディレクトリ内に含まれるルートファイルをロードします。どうぞ`RouteServiceProvider`コードを開いて解析し、それがどのように機能するかを確認してください！

アプリケーションが初期起動され、すべてのサービスプロバイダが登録されると、`Request`がルータに渡されてディスパッチされます。ルータは、ルートまたはコントローラへリクエストをディスパッチし、ルート固有のミドルウェアを実行します。

ミドルウェアは、アプリケーションに入るHTTPリクエストをフィルタリングまたは検査するための便利なメカニズムを提供しています。たとえば、Laravelには、アプリケーションのユーザーが認証されているかを確認するミドルウェアが含まれています。ユーザーが認証されていない場合、このミドルウェアはユーザーをログイン画面にリダイレクトします。そしてユーザーが認証されている場合、ミドルウェアはリクエストをアプリケーションへ進めることを許可します。HTTPカーネルの`$middleware`プロパティで定義されているもののように、アプリケーション内のすべてのルートで適用されるミドルウェアもあれば、特定のルートまたはルートグループにのみ割り当てられるミドルウェアもあります。ミドルウェアの詳細については、完全な[ミドルウェアのドキュメント](/docs/{{version}}/middleware)を参照してください。

リクエストが一致したルートへ割り当てられたすべてのミドルウェアをパスした場合は、ルートまたはコントローラメソッドが実行され、ルートまたはコントローラメソッドが返すレスポンスがルートのミドルウェアチェーンを介して返送されます。

<a name="finishing-up"></a>
### 最後

ルートまたはコントローラメソッドがレスポンスを返すと、レスポンスはルートのミドルウェアを介して外側に戻り、アプリケーションに送信レスポンスを変更または検査する機会を与えます。

最後に、レスポンスがミドルウェアを経由して戻ると、HTTPカーネルの`handle`メソッドがレスポンスオブジェクトを返し、`index.php`ファイルが返ってきたレスポンスに対して`send`メソッドを呼び出します。`send`メソッドは、レスポンスコンテンツをユーザーのWebブラウザに送信します。Laravelリクエストのライフサイクル全体の旅を終えました！

<a name="focus-on-service-providers"></a>
## サービスプロバイダに注目

サービスプロバイダは、Laravelアプリケーションを初期起動するための真の鍵です。アプリケーションインスタンスが作成され、サービスプロバイダが登録され、リクエストが初期起動を終えたアプリケーションに渡されます。とても簡単です！

Laravelアプリケーションがどのように構築され、サービスプロバイダを介して初期起動されるかをしっかりと把握することは非常に価値があります。アプリケーションのデフォルトのサービスプロバイダは、`app/Providers`ディレクトリに保存されます。

デフォルトの`AppServiceProvider`はほとんど空です。このプロバイダは、アプリケーション独自の初期起動処理およびサービスコンテナ結合を追加するのに最適な場所です。大規模なアプリケーションの場合、アプリケーションで使用する特定のサービスに対して、それぞれがよりきめ細かい初期処理を備えた複数のサービスプロバイダを作成することをお勧めします。
