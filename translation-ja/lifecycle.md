# リクエストのライフサイクル

- [イントロダクション](#introduction)
- [概論](#lifecycle-overview)
- [サービスプロバイダの精査](#focus-on-service-providers)

<a name="introduction"></a>
## イントロダクション

「現実の世界」である道具を使用する場合、それがどのように動作するかを理解しておくほうが、自信が持てます。アプリケーションの開発も違いはありません。開発ツールがどのように働くのかを理解すれば、より快適に自信を持って使用できるのです。

このドキュメントの目的は、どのようにLaravelが動作しているのか、ハイレベルな概念を理解してもらうためです。フレームワークの概念をより良く知ってもらうことで、すべてに対し「不可解さ」が減り、より自信を持ってアプリケーションを開発してもらえます。これらの言葉を今すぐ理解できなくても、気落ちしないでください。ただ何が行われているかを理解するための基本だけを理解してください。ドキュメントの他のセクションで明確にされる内容を理解すれば、知識は育っていくことでしょう。

<a name="lifecycle-overview"></a>
## 概論

### 始まり

アプリケーションに対するリクエストは、すべて`public/index.php`ファイルが入り口になります。Webサーバ(Apache/Nginx)の設定により、すべてのリクエストをこのファイルへ渡しています。`index.php`ファイルは、さほどコードを持っていません。フレームワークの残りをロードするための入り口にすぎません。

`index.php`ファイルは、Composerが生成したオートローダーの定義をロードします。それから、`bootstrap/app.php`スクリプトから、Laravelアプリケーションのインスタンスを取得します。Laravel自身の最初のアクションは、アプリケーション／[サービスコンテナ](/docs/{{version}}/container)のインスタンスを生成することです。

### HTTP/Consoleカーネル

次にアプリケーション起動のきっかけにより、送信されてきたリクエストをHTTPカーネルかコンソールカーネルのどちらかに送ります。これらのカーネルは、全リクエストフローの中心に位置し動作します。ここでは`app/Http/Kernel.php`にあるHTTPカーネルへ焦点を合わせます。

HTTPカーネルはIlluminate\Foundation\Http\Kernelクラスを拡張しています。このKernelクラスは、リクエストの実行前に処理されるbootstrappers（起動コード）の配列を定義してます。これらの起動コードはエラー処理、ログ設定、[アプリケーション動作環境の決定](/docs/{{version}}/configuration#environment-configuration)、そのほか実際にリクエストが処理される前に行う必要のあるタスクです。

HTTPカーネルはさらに、アプリケーションによりリクエストが処理される前に通す必要のある、HTTP[ミドルウェア](/docs/{{version}}/middleware)のリストも定義しています。これらのミドルウェアは[HTTPセッション](/docs/{{version}}/session)の読み書き、アプリケーションがメンテナンスモードであるかの決定、[CSRFトークンの確認](/docs/{{version}}/csrf)などを行います。

HTTPカーネルの`handle`メソッドの使い方はとてもシンプルで、`Request`を受け取り、`Response`をリターンします。カーネルをアプリケーション全体を表す大きなブラックボックスだと考えてください。HTTPリクエストを流し込み、HTTPレスポンスが返ってきます。

#### サービスプロバイダ

カーネル初期起動時の重要な処理の一つは、アプリケーションの[サービスプロバイダ](/docs/{{version}}/providers)をロードすることです。アプリケーションの全サービスプロバイダは、`config/app.php`ファイルの`providers`配列で設定されています。最初に全プロバイダの`register`メソッドが呼び出され、その後に登録されている全プロバイダの`boot`メソッドが呼び出されます。

サービスプロバイダはデータベース、キュー、バリデーション、ルーティングなど、フレームワークのさまざまなコンポーネントの初期起動処理に責任をもちます。フレームワークにより提供されている全機能を初期化し、設定するものですから、サービスプロバイダはLaravelの初期処理の過程全体で一番重要な機能です。

#### リクエストのディスパッチ

アプリケーションの初期処理が済み、全サービスプロバイダが登録されたら、ディスパッチ（実行制御の移行）するためにルーターへ`Request`が手渡されます。ルーターはそのリクエストをルートかコントローラにディスパッチし、その時にルートへ指定されているミドルウェアも実行されます。

<a name="focus-on-service-providers"></a>
## サービスプロバイダの精査

サービスプロバイダはLaravelアプリケーションの初期起動段階における、まさに鍵となるものです。アプリケーションインスタンスが作成され、サービスプロバイダが登録され、初期起動を終えたアプリケーションでリクエストが処理されます。とてもシンプルです！

Laravelアプリケーションがどう構築されているか、そしてサービスプロバイダによる初期起動の仕組みをしっかりと把握することは、とても重要です。皆さんのアプリケーションのためのデフォルトサービスプロバイダは、`app/Providers`ディレクトリに設置されています。

`AppServiceProvider`はデフォルトで完全に空っぽです。このプロバイダは皆さんのアプリケーション自身の初期起動や、サービスコンテナの結合を追加するために用意されています。大きなアプリケーションであれば、まとまった初期起動種別ごとに分け、好きなだけサービスプロバイダを作成できます。
